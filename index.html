<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’²å…‹ç‰Œæ±ºé¬¥ - å–®äººæ¨¡å¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .card {
            width: 80px;
            height: 112px;
            border: 1px solid #9ca3af;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .card.played {
            transform: scale(1.1);
            border-width: 2px;
            border-color: #2563eb;
        }
        .card-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .card-suit {
            font-size: 1.25rem;
        }
        .card-back {
            background: linear-gradient(135deg, #6b7280 25%, transparent 25%) -40px 0, linear-gradient(225deg, #6b7280 25%, transparent 25%) -40px 0, linear-gradient(315deg, #6b7280 25%, transparent 25%), linear-gradient(45deg, #6b7280 25%, transparent 25%);
            background-size: 80px 80px;
            background-color: #4b5563;
        }
        .heart { color: #ef4444; }
        .diamond { color: #ef4444; }
        .spade { color: #1f2937; }
        .club { color: #1f2937; }
        #game-screen {
            background-image: radial-gradient(circle, #374151, #1f2937);
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- ä¸»å®¹å™¨ -->
    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- å¤§å»³ä»‹é¢ -->
        <div id="lobby" class="bg-slate-800 p-8 rounded-lg shadow-2xl">
            <h1 class="text-4xl font-bold text-center mb-2">æ’²å…‹ç‰Œæ±ºé¬¥</h1>
            <p class="text-center text-slate-400 mb-8">å–®äººå°æˆ°ç‰ˆ (AI åŠ æŒ)</p>
            <div class="space-y-4">
                <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" class="w-full bg-slate-700 text-white p-3 rounded-md border border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="ç©å®¶">
                <button id="start-game-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200">é–‹å§‹éŠæˆ²</button>
            </div>
             <p id="lobby-error" class="text-red-400 text-center mt-4"></p>
        </div>

        <!-- éŠæˆ²ä»‹é¢ -->
        <div id="game-screen" class="hidden h-screen max-h-[800px] w-full max-w-md mx-auto flex flex-col p-4 rounded-lg shadow-2xl relative">
            <!-- é ‚éƒ¨è³‡è¨Š -->
            <div class="flex justify-between items-center mb-4 text-slate-300">
                <div id="player-name-display-top" class="font-bold">ç©å®¶</div>
                <div>ç¬¬ <span id="round-counter">1</span> å›åˆ</div>
                <div class="text-lg">ğŸ† <span id="player-wins">0</span> - <span id="computer-wins">0</span></div>
            </div>

            <!-- é›»è…¦å€åŸŸ -->
            <div id="computer-area" class="flex flex-col items-center justify-center flex-grow">
                <div class="text-center mb-2">
                    <div class="flex items-center justify-center space-x-2">
                        <div id="computer-name" class="text-lg font-bold text-slate-300">é›»è…¦</div>
                    </div>
                    <div class="text-2xl font-bold text-red-500">â¤ï¸ <span id="computer-hp">25</span></div>
                </div>
                <div class="relative w-40 h-40 flex items-center justify-center">
                    <div id="computer-played-card" class="absolute"></div>
                </div>
                <div id="computer-hand" class="flex justify-center space-x-[-40px] mt-2">
                    <!-- é›»è…¦æ‰‹ç‰Œå°‡æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- éŠæˆ²æ—¥èªŒ -->
            <div id="game-log" class="text-center text-amber-300 h-10 my-2 text-sm flex items-center justify-center"></div>
            <div id="gemini-actions" class="h-10 my-2 flex items-center justify-center space-x-4"></div>

            <!-- ç©å®¶å€åŸŸ -->
            <div id="player-area" class="flex flex-col items-center justify-center flex-grow">
                <div id="player-hand" class="flex justify-center space-x-[-20px] mb-2">
                    <!-- ç©å®¶æ‰‹ç‰Œå°‡æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
                <div class="relative w-40 h-40 flex items-center justify-center">
                    <div id="player-played-card" class="absolute"></div>
                </div>
                <div class="text-center mt-2">
                    <div class="text-2xl font-bold text-green-500">â¤ï¸ <span id="player-hp">25</span></div>
                </div>
            </div>
            
             <!-- éŠæˆ²çµæŸå½ˆçª— -->
            <div id="game-over-modal" class="hidden absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center text-center p-8">
                <h2 id="game-over-message" class="text-5xl font-bold mb-4"></h2>
                <p id="final-score" class="text-2xl text-slate-300 mb-8"></p>
                <button id="back-to-lobby-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-200">è¿”å›å¤§å»³</button>
            </div>
        </div>

    </div>

    <script type="module">
        // UI å…ƒç´ 
        const lobby = document.getElementById('lobby');
        const gameScreen = document.getElementById('game-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerNameInput = document.getElementById('player-name');
        const lobbyError = document.getElementById('lobby-error');
        
        // éŠæˆ²ç‹€æ…‹
        let gameState = {};

        // --- Gemini API ---
        async function generateGeminiMessage(prompt) {
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 50,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                     throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return text?.trim() || "â€¦";
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "æˆ‘ç„¡è©±å¯èªªã€‚";
            }
        }

        // --- å¡ç‰ŒéŠæˆ²æ ¸å¿ƒé‚è¼¯ ---

        function createDeck() {
            const suits = ['â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const deck = [];
            for (const suit of suits) {
                for (const value of values) {
                    deck.push({ suit, value });
                }
            }
            return deck;
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function getCardValue(card) {
            if (!card || !card.value) return 0;
            const value = card.value;
            if (value === 'A') return 1;
            if (value === 'J') return 1;
            if (value === 'Q') return 2;
            if (value === 'K') return 11;
            return parseInt(value);
        }

        function getCardType(card) {
            if (!card || !card.suit) return 'none';
            if (['â™ ï¸', 'â™£ï¸'].includes(card.suit)) return 'attack';
            if (card.suit === 'â™¦ï¸') return 'counter';
            if (card.suit === 'â™¥ï¸') return 'heal';
        }

        // --- å–®äººéŠæˆ²é‚è¼¯ ---

        startGameBtn.onclick = () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                lobbyError.textContent = "è«‹å…ˆè¼¸å…¥æš±ç¨±ã€‚";
                return;
            }
            
            lobby.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            initGame(playerName);
        };

        function initGame(playerName) {
            gameState = {
                playerName: playerName,
                playerWins: 0,
                computerWins: 0,
                currentRound: 1,
                isPlayerTurn: true,
                log: ""
            };
            startNewRound();
        }

        function startNewRound() {
            document.getElementById('gemini-actions').innerHTML = '';
            document.getElementById('player-played-card').innerHTML = '';
            document.getElementById('computer-played-card').innerHTML = '';

            const deck = shuffleDeck(createDeck());
            gameState.playerHp = 25;
            gameState.computerHp = 25;
            gameState.playerHand = deck.splice(0, 5);
            gameState.computerHand = deck.splice(0, 5);
            gameState.deck = deck;
            gameState.isPlayerTurn = true;
            gameState.log = `ç¬¬ ${gameState.currentRound} å›åˆé–‹å§‹ï¼è«‹å‡ºç‰Œã€‚`;
            renderGame();
        }

        function playCard(card, index) {
            if (!gameState.isPlayerTurn) return;
            
            gameState.isPlayerTurn = false; // é–å®šç©å®¶æ“ä½œ
            
            // ç©å®¶å‡ºç‰Œ
            const playerCard = gameState.playerHand.splice(index, 1)[0];
            
            // é›»è…¦å‡ºç‰Œ
            const { card: computerCard, index: computerIndex } = computerChooseCard(playerCard);
            gameState.computerHand.splice(computerIndex, 1);

            // æ¸²æŸ“å‡ºçš„ç‰Œ
            document.getElementById('player-played-card').innerHTML = renderCard(playerCard);
            document.getElementById('computer-played-card').innerHTML = renderCard(computerCard);
            renderGame(); // æ›´æ–°æ‰‹ç‰Œæ•¸é‡

            // å»¶é²ä¸€ä¸‹å†çµç®—
            setTimeout(() => {
                resolveRound(playerCard, computerCard);
            }, 1000);
        }

        function computerChooseCard(playerCard) {
            const computerHand = gameState.computerHand;
            const playerCardType = getCardType(playerCard);
            let bestCard = null;
            let bestCardIndex = -1;

            // ç­–ç•¥1: å¦‚æœç©å®¶æ”»æ“Šï¼Œå„ªå…ˆè€ƒæ…®åæ“Š
            if (playerCardType === 'attack') {
                const counters = computerHand.map((c, i) => ({ card: c, index: i }))
                                         .filter(item => getCardType(item.card) === 'counter');
                if (counters.length > 0) {
                    // é¸æ“‡æœ€å¼·çš„åæ“Šç‰Œ
                    counters.sort((a, b) => getCardValue(b.card) - getCardValue(a.card));
                    return counters[0];
                }
            }

            // ç­–ç•¥2: å¦‚æœè¡€é‡ä½æ–¼10ï¼Œå„ªå…ˆè€ƒæ…®è£œè¡€
            if (gameState.computerHp < 10) {
                 const healers = computerHand.map((c, i) => ({ card: c, index: i }))
                                         .filter(item => getCardType(item.card) === 'heal');
                if (healers.length > 0) {
                     healers.sort((a, b) => getCardValue(b.card) - getCardValue(a.card));
                    return healers[0];
                }
            }
            
            // ç­–ç•¥3: å„ªå…ˆå‡ºæ”»æ“Šç‰Œ
            const attackers = computerHand.map((c, i) => ({ card: c, index: i }))
                                         .filter(item => getCardType(item.card) === 'attack');
            if (attackers.length > 0) {
                 attackers.sort((a, b) => getCardValue(b.card) - getCardValue(a.card));
                return attackers[0];
            }

            // ç­–ç•¥4: å¦‚æœæ²’æœ‰æ”»æ“Šç‰Œï¼Œéš¨æ©Ÿå‡º
            bestCardIndex = Math.floor(Math.random() * computerHand.length);
            bestCard = computerHand[bestCardIndex];
            return { card: bestCard, index: bestCardIndex };
        }

        async function resolveRound(playerCard, computerCard) {
            const p1Type = getCardType(playerCard);
            const p2Type = getCardType(computerCard);
            const p1Value = getCardValue(playerCard);
            const p2Value = getCardValue(computerCard);

            let logMessages = [`ä½ æ‰“å‡º ${playerCard.value}${playerCard.suit}`, `é›»è…¦æ‰“å‡º ${computerCard.value}${computerCard.suit}`];

            // 1. æ”»æ“Šéšæ®µ
            if (p1Type === 'attack' && p2Type !== 'counter') {
                gameState.computerHp -= p1Value;
                logMessages.push(`ä½ é€ æˆ ${p1Value} é»å‚·å®³ã€‚`);
            }
            if (p2Type === 'attack' && p1Type !== 'counter') {
                gameState.playerHp -= p2Value;
                logMessages.push(`é›»è…¦é€ æˆ ${p2Value} é»å‚·å®³ã€‚`);
            }

            // 2. åæ“Šéšæ®µ
            if (p1Type === 'counter' && p2Type === 'attack') {
                gameState.computerHp -= p1Value;
                logMessages.push(`ä½ åæ“Šäº† ${p1Value} é»å‚·å®³ï¼`);
            }
            if (p2Type === 'counter' && p1Type === 'attack') {
                gameState.playerHp -= p2Value;
                logMessages.push(`é›»è…¦åæ“Šäº† ${p2Value} é»å‚·å®³ï¼`);
            }

            // 3. æ²»ç™‚éšæ®µ
            if (p1Type === 'heal') {
                gameState.playerHp = Math.min(25, gameState.playerHp + p1Value);
                logMessages.push(`ä½ æ¢å¾©äº† ${p1Value} é»ç”Ÿå‘½ã€‚`);
            }
            if (p2Type === 'heal') {
                gameState.computerHp = Math.min(25, gameState.computerHp + p2Value);
                logMessages.push(`é›»è…¦æ¢å¾©äº† ${p2Value} é»ç”Ÿå‘½ã€‚`);
            }

            gameState.playerHp = Math.max(0, gameState.playerHp);
            gameState.computerHp = Math.max(0, gameState.computerHp);
            
            // åˆ¤æ–·å›åˆå‹è² 
            let roundWinner = null;
            if (gameState.playerHp <= 0 && gameState.computerHp > 0) {
                roundWinner = 'computer';
                logMessages.push(`é›»è…¦è´å¾—æ­¤å›åˆï¼`);
            } else if (gameState.computerHp <= 0 && gameState.playerHp > 0) {
                roundWinner = 'player';
                logMessages.push(`ä½ è´å¾—æ­¤å›åˆï¼`);
            } else if (gameState.playerHp <= 0 && gameState.computerHp <= 0) {
                logMessages.push("æ­¤å›åˆå¹³æ‰‹ï¼");
            } else {
                 logMessages.push("å›åˆçµæŸï¼Œé›™æ–¹éƒ½é‚„æ´»è‘—ï¼");
            }

            gameState.log = logMessages.join(' ');
            if (roundWinner === 'player') gameState.playerWins++;
            if (roundWinner === 'computer') gameState.computerWins++;

            renderGame();
            handleGeminiActions(roundWinner);
            
            // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ (BO5)
            if (gameState.playerWins >= 3 || gameState.computerWins >= 3) {
                setTimeout(showGameOver, 2000);
            } else {
                 setTimeout(goToNextRound, 4000);
            }
        }
        
        function handleGeminiActions(roundWinner){
            const geminiActions = document.getElementById('gemini-actions');
            geminiActions.innerHTML = '';
             if (roundWinner) {
                let buttonText, prompt;
                if (roundWinner === 'player') {
                    buttonText = 'ç™¼è¡¨å‹åˆ©æ„Ÿè¨€ ğŸ¤';
                    prompt = `ä½ æ˜¯ä¸€ä½æ’²å…‹ç‰Œé«˜æ‰‹ï¼Œå‰›åœ¨ã€Œæ’²å…‹ç‰Œæ±ºé¬¥ã€éŠæˆ²ä¸­è´äº†ä¸€å€‹å›åˆã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ç”Ÿæˆä¸€å¥ç°¡çŸ­ (15å­—ä»¥å…§)ã€æœ‰è¶£ä¸”å¸¶é»å—†è²æ„å‘³çš„å‹åˆ©æ„Ÿè¨€ã€‚`;
                } else {
                    buttonText = 'ç¨±è®šå°æ‰‹ ğŸ‘';
                    prompt = `ä½ æ˜¯ä¸€ä½æœ‰é¢¨åº¦çš„æ’²å…‹ç‰Œç©å®¶ï¼Œå‰›åœ¨ã€Œæ’²å…‹ç‰Œæ±ºé¬¥ã€éŠæˆ²ä¸­è¼¸äº†ä¸€å€‹å›åˆã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ç”Ÿæˆä¸€å¥ç°¡çŸ­ (15å­—ä»¥å…§)ã€èª æ‡‡åœ°ç¨±è®šå°æ‰‹çš„è©±ã€‚`;
                }

                const geminiBtn = document.createElement('button');
                geminiBtn.textContent = buttonText;
                geminiBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition';
                geminiBtn.onclick = async () => {
                    geminiBtn.disabled = true;
                    geminiBtn.textContent = 'ç”Ÿæˆä¸­...';
                    const message = await generateGeminiMessage(prompt);
                    document.getElementById('game-log').innerHTML += `<br/><span class='text-purple-300'>${gameState.playerName}: "${message}"</span>`;
                    geminiActions.innerHTML = '';
                };
                geminiActions.appendChild(geminiBtn);
            }
        }

        function goToNextRound() {
            gameState.currentRound++;
            startNewRound();
        }
        
        function showGameOver(){
            const modal = document.getElementById('game-over-modal');
            const message = document.getElementById('game-over-message');
            const score = document.getElementById('final-score');
            
            if(gameState.playerWins >= 3){
                message.textContent = "æ­å–œä½ ç²å‹ï¼";
            } else {
                message.textContent = "å¯æƒœï¼Œé›»è…¦ç²å‹äº†ï¼";
            }
            score.textContent = `æœ€çµ‚æ¯”åˆ† ${gameState.playerWins} - ${gameState.computerWins}`;
            modal.classList.remove('hidden');
        }


        // --- ç•«é¢æ¸²æŸ“ ---
        
        function renderCard(card, isFaceDown = false) {
            if (isFaceDown) {
                return `<div class="card card-back"></div>`;
            }
            
            const suitClass = { 'â™ ï¸': 'spade', 'â™£ï¸': 'club', 'â™¥ï¸': 'heart', 'â™¦ï¸': 'diamond' }[card.suit];
            return `
                <div class="card ${suitClass}">
                    <div class="text-left">
                        <span class="card-value">${card.value}</span>
                        <span class="card-suit">${card.suit}</span>
                    </div>
                    <div class="text-right self-end rotate-180">
                        <span class="card-value">${card.value}</span>
                        <span class="card-suit">${card.suit}</span>
                    </div>
                </div>
            `;
        }
        
        function renderGame() {
            if (!gameState || !gameState.playerName) return;

            // æ›´æ–°é ‚éƒ¨è³‡è¨Š
            document.getElementById('player-name-display-top').textContent = gameState.playerName;
            document.getElementById('round-counter').textContent = gameState.currentRound;
            document.getElementById('player-wins').textContent = gameState.playerWins;
            document.getElementById('computer-wins').textContent = gameState.computerWins;

            // æ›´æ–°HP
            document.getElementById('player-hp').textContent = gameState.playerHp;
            document.getElementById('computer-hp').textContent = gameState.computerHp;
            
            // æ¸²æŸ“æ‰‹ç‰Œ
            const playerHandDiv = document.getElementById('player-hand');
            playerHandDiv.innerHTML = '';
            gameState.playerHand.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.innerHTML = renderCard(card);
                if (gameState.isPlayerTurn) {
                     cardEl.onclick = () => playCard(card, index);
                }
                playerHandDiv.appendChild(cardEl.firstChild);
            });
            
            const computerHandDiv = document.getElementById('computer-hand');
            computerHandDiv.innerHTML = Array(gameState.computerHand.length).fill(renderCard(null, true)).join('');
            
            // æ›´æ–°æ—¥èªŒ
            document.getElementById('game-log').innerHTML = gameState.log;
        }
        
        document.getElementById('back-to-lobby-btn').onclick = () => {
             window.location.reload();
        };

    </script>
</body>
</html>

